name: âœ… Calidad TÃ©cnica y SEO

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. COMPILACIÃ“N Y TYPESCRIPT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  compilacion:
    name: ğŸ”¨ CompilaciÃ³n Next.js
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Verificar TypeScript (sin errores de tipos)
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Lint (errores de cÃ³digo)
        run: npm run lint
        continue-on-error: true

      - name: Build de producciÃ³n
        run: npm run build
        env:
          NODE_ENV: production

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. VALIDACIÃ“N DE ARCHIVOS MDX (CONTENIDO)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  contenido-mdx:
    name: ğŸ“ ValidaciÃ³n de Contenido MDX
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Comprobar campos obligatorios en frontmatter MDX
        run: |
          node - << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const glob = require('glob').sync ?? require('glob').globSync;

          // Buscar todos los archivos MDX en /content
          const files = fs.readdirSync('./content', { recursive: true })
            .filter(f => f.endsWith('.mdx') || f.endsWith('.md'))
            .map(f => path.join('./content', f));

          let errores = [];

          files.forEach(file => {
            const content = fs.readFileSync(file, 'utf-8');
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);

            if (!frontmatterMatch) {
              errores.push(`âŒ Sin frontmatter: ${file}`);
              return;
            }

            const frontmatter = frontmatterMatch[1];
            const camposObligatorios = ['title', 'description', 'date'];

            camposObligatorios.forEach(campo => {
              if (!frontmatter.includes(`${campo}:`)) {
                errores.push(`âŒ Falta campo '${campo}' en: ${file}`);
              }
            });

            // Comprobar que description no estÃ¡ vacÃ­a ni es "..."
            const descMatch = frontmatter.match(/description:\s*["']?(.+?)["']?\n/);
            if (descMatch && (descMatch[1].trim() === '...' || descMatch[1].trim() === '')) {
              errores.push(`âš ï¸  Description vacÃ­a o incompleta en: ${file}`);
            }

            // Comprobar que title tiene longitud razonable para SEO (30-70 chars)
            const titleMatch = frontmatter.match(/title:\s*["']?(.+?)["']?\n/);
            if (titleMatch) {
              const len = titleMatch[1].trim().length;
              if (len < 20) errores.push(`âš ï¸  TÃ­tulo demasiado corto (${len} chars) en: ${file}`);
              if (len > 70) errores.push(`âš ï¸  TÃ­tulo demasiado largo (${len} chars) en: ${file}`);
            }
          });

          if (errores.length > 0) {
            console.log('\nğŸ” Problemas encontrados en archivos MDX:\n');
            errores.forEach(e => console.log(e));
            // Solo falla el build si hay campos obligatorios faltantes (âŒ), no warnings (âš ï¸)
            const criticos = errores.filter(e => e.startsWith('âŒ'));
            if (criticos.length > 0) process.exit(1);
          } else {
            console.log('âœ… Todos los archivos MDX tienen frontmatter correcto.');
          }
          EOF

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. VERIFICACIÃ“N SEO TÃ‰CNICO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  seo-tecnico:
    name: ğŸ” SEO TÃ©cnico
    runs-on: ubuntu-latest
    needs: compilacion
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Build para anÃ¡lisis
        run: npm run build
        env:
          NODE_ENV: production

      - name: Comprobar que sitemap.xml existe y tiene contenido
        run: |
          if [ -f ".next/server/app/sitemap.xml/route.js" ] || [ -f "public/sitemap.xml" ] || grep -r "sitemap" src/ --include="*.ts" --include="*.tsx" -l | head -1; then
            echo "âœ… ConfiguraciÃ³n de sitemap encontrada"
          else
            echo "âŒ No se encontrÃ³ sitemap.ts ni sitemap.xml â€” Google no podrÃ¡ rastrear el sitio correctamente"
            exit 1
          fi

      - name: Comprobar que robots.txt existe
        run: |
          if [ -f "public/robots.txt" ] || grep -r "robots" src/ --include="*.ts" -l | head -1; then
            echo "âœ… robots.txt o configuraciÃ³n encontrada"
          else
            echo "âš ï¸  No se encontrÃ³ robots.txt en /public ni robots.ts en /src/app"
          fi

      - name: Comprobar imÃ¡genes sin alt text en componentes
        run: |
          echo "ğŸ” Buscando imÃ¡genes sin alt text..."
          # Busca <img sin alt o <Image sin alt en archivos TSX
          PROBLEMAS=$(grep -rn "<img " src/ --include="*.tsx" | grep -v 'alt=' || true)
          PROBLEMAS2=$(grep -rn "<Image " src/ --include="*.tsx" | grep -v 'alt=' || true)
          if [ -n "$PROBLEMAS" ] || [ -n "$PROBLEMAS2" ]; then
            echo "âš ï¸  ImÃ¡genes sin atributo alt encontradas:"
            echo "$PROBLEMAS"
            echo "$PROBLEMAS2"
          else
            echo "âœ… Todas las imÃ¡genes tienen alt text"
          fi

      - name: Comprobar uso de next/image (no <img> nativa)
        run: |
          IMG_NATIVA=$(grep -rn "<img " src/ --include="*.tsx" | grep -v "// " || true)
          if [ -n "$IMG_NATIVA" ]; then
            echo "âš ï¸  Se encontraron etiquetas <img> nativas (usa next/image para mejor rendimiento):"
            echo "$IMG_NATIVA"
          else
            echo "âœ… Todas las imÃ¡genes usan next/image"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. ANÃLISIS DE BUNDLE (TAMAÃ‘O)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bundle-size:
    name: ğŸ“¦ TamaÃ±o del Bundle
    runs-on: ubuntu-latest
    needs: compilacion
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Build con anÃ¡lisis de bundle
        run: npm run build
        env:
          NODE_ENV: production
          ANALYZE: false

      - name: Comprobar tamaÃ±o de pÃ¡ginas principales
        run: |
          echo "ğŸ“Š Analizando tamaÃ±o del build..."
          if [ -d ".next" ]; then
            # Mostrar tamaÃ±o de los chunks principales
            find .next/static/chunks -name "*.js" -size +200k 2>/dev/null | while read f; do
              size=$(du -sh "$f" | cut -f1)
              echo "âš ï¸  Chunk grande ($size): $f"
            done
            
            # Total del build
            total=$(du -sh .next | cut -f1)
            echo "ğŸ“¦ TamaÃ±o total del build: $total"
            echo "âœ… AnÃ¡lisis de bundle completado"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. RESUMEN FINAL
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  resumen:
    name: ğŸ“‹ Resumen de Calidad
    runs-on: ubuntu-latest
    needs: [compilacion, contenido-mdx, seo-tecnico, bundle-size]
    if: always()
    steps:
      - name: Resultado final
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  AUDITORÃA TÃ‰CNICA â€” derechoartificial.com"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Si ves este mensaje, el deploy a Vercel es seguro."
          echo ""
          echo "Revisa los jobs anteriores para ver advertencias (âš ï¸)"
          echo "Las advertencias no bloquean el deploy pero conviene revisarlas."
          echo "Los errores crÃ­ticos (âŒ) sÃ­ bloquean el deploy."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
