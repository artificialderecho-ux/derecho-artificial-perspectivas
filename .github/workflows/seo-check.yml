name: ğŸ” SEO Check

on:
  push:
    branches: [main]
    paths:
      - 'content/**'        # Se activa al publicar artÃ­culos
      - 'src/app/**'        # Se activa al cambiar pÃ¡ginas
      - 'public/**'         # Se activa al cambiar robots.txt, imÃ¡genes, etc.
  pull_request:
    branches: [main]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. FRONTMATTER SEO â€” Calidad de los metadatos de artÃ­culos
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontmatter-seo:
    name: ğŸ“ Metadatos SEO en artÃ­culos MDX
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Analizar frontmatter de todos los artÃ­culos
        run: |
          node << 'EOF'
          const fs   = require('fs');
          const path = require('path');

          // â”€â”€ ConfiguraciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const CONTENT_DIR   = './content';
          const MAX_TITLE_LEN = 70;
          const MIN_TITLE_LEN = 30;
          const MAX_DESC_LEN  = 160;
          const MIN_DESC_LEN  = 80;
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          function findMdxFiles(dir, files = []) {
            if (!fs.existsSync(dir)) return files;
            fs.readdirSync(dir, { withFileTypes: true }).forEach(entry => {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) findMdxFiles(full, files);
              else if (/\.(mdx?|md)$/.test(entry.name)) files.push(full);
            });
            return files;
          }

          const archivos = findMdxFiles(CONTENT_DIR);
          if (archivos.length === 0) {
            console.log('âš ï¸  No se encontraron archivos MDX en /content');
            process.exit(0);
          }

          let warnings = 0;
          let errores  = 0;

          archivos.forEach(file => {
            const rel     = path.relative('.', file);
            const content = fs.readFileSync(file, 'utf-8');
            const fm      = content.match(/^---\n([\s\S]*?)\n---/);

            if (!fm) {
              console.log(`âŒ Sin frontmatter: ${rel}`);
              errores++;
              return;
            }

            const raw = fm[1];

            // â”€â”€ Campos obligatorios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ['title', 'description', 'date'].forEach(campo => {
              if (!new RegExp(`^${campo}:`, 'm').test(raw)) {
                console.log(`âŒ Falta '${campo}': ${rel}`);
                errores++;
              }
            });

            // â”€â”€ Longitud del title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const titleM = raw.match(/^title:\s*["']?(.+?)["']?\s*$/m);
            if (titleM) {
              const t = titleM[1].trim();
              if (t.length < MIN_TITLE_LEN) {
                console.log(`âš ï¸  Title corto (${t.length} chars, mÃ­n ${MIN_TITLE_LEN}): ${rel}`);
                warnings++;
              } else if (t.length > MAX_TITLE_LEN) {
                console.log(`âš ï¸  Title largo (${t.length} chars, mÃ¡x ${MAX_TITLE_LEN}): ${rel}`);
                warnings++;
              }
            }

            // â”€â”€ Longitud de description â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const descM = raw.match(/^description:\s*["']?([\s\S]+?)["']?\s*$/m);
            if (descM) {
              const d = descM[1].trim();
              if (d === '...' || d === '') {
                console.log(`âŒ Description vacÃ­a: ${rel}`);
                errores++;
              } else if (d.length < MIN_DESC_LEN) {
                console.log(`âš ï¸  Description corta (${d.length} chars, mÃ­n ${MIN_DESC_LEN}): ${rel}`);
                warnings++;
              } else if (d.length > MAX_DESC_LEN) {
                console.log(`âš ï¸  Description larga (${d.length} chars, mÃ¡x ${MAX_DESC_LEN}): ${rel}`);
                warnings++;
              }
            }

            // â”€â”€ Formato de fecha â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const dateM = raw.match(/^date:\s*["']?(.+?)["']?\s*$/m);
            if (dateM && !/^\d{4}-\d{2}-\d{2}$/.test(dateM[1].trim())) {
              console.log(`âš ï¸  Fecha no estÃ¡ en formato YYYY-MM-DD: ${rel} â†’ "${dateM[1].trim()}"`);
              warnings++;
            }

            // â”€â”€ Canonical / slug duplicados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const slugM = raw.match(/^slug:\s*["']?(.+?)["']?\s*$/m);
            if (slugM && /[A-Z\s]/.test(slugM[1])) {
              console.log(`âš ï¸  Slug con mayÃºsculas o espacios (malo para URLs): ${rel}`);
              warnings++;
            }
          });

          // â”€â”€ Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          console.log('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
          console.log(`ğŸ“Š Archivos analizados : ${archivos.length}`);
          console.log(`âŒ Errores crÃ­ticos     : ${errores}`);
          console.log(`âš ï¸  Advertencias SEO    : ${warnings}`);
          console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

          if (errores > 0) {
            console.log('\nâŒ Corrige los errores crÃ­ticos antes de publicar.');
            process.exit(1);
          } else if (warnings > 0) {
            console.log('\nâš ï¸  Hay advertencias SEO. El deploy continÃºa pero revÃ­salas.');
          } else {
            console.log('\nâœ… Todos los artÃ­culos tienen metadatos SEO correctos.');
          }
          EOF

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. SITEMAP â€” Existe y tiene contenido
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sitemap:
    name: ğŸ—ºï¸ Sitemap
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Comprobar que existe configuraciÃ³n de sitemap
        run: |
          SITEMAP_APP=$(find src/app -name "sitemap.ts" -o -name "sitemap.tsx" 2>/dev/null | head -1)
          SITEMAP_PUB=$(find public -name "sitemap.xml" 2>/dev/null | head -1)

          if [ -n "$SITEMAP_APP" ]; then
            echo "âœ… Sitemap dinÃ¡mico encontrado: $SITEMAP_APP"
          elif [ -n "$SITEMAP_PUB" ]; then
            echo "âœ… Sitemap estÃ¡tico encontrado: $SITEMAP_PUB"
            # Contar URLs en el sitemap estÃ¡tico
            URLS=$(grep -c "<url>" "$SITEMAP_PUB" || echo 0)
            echo "   â†’ $URLS URLs incluidas"
            if [ "$URLS" -lt 5 ]; then
              echo "âš ï¸  El sitemap tiene muy pocas URLs. Â¿EstÃ¡ incluyendo todos los artÃ­culos?"
            fi
          else
            echo "âŒ No se encontrÃ³ sitemap.ts ni sitemap.xml"
            echo "   Google no podrÃ¡ rastrear eficientemente el sitio."
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. ROBOTS.TXT â€” No bloquea a Google
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  robots:
    name: ğŸ¤– robots.txt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verificar robots.txt no bloquea indexaciÃ³n
        run: |
          ROBOTS_PUB="public/robots.txt"
          ROBOTS_APP=$(find src/app -name "robots.ts" -o -name "robots.tsx" 2>/dev/null | head -1)

          if [ -f "$ROBOTS_PUB" ]; then
            echo "ğŸ“„ robots.txt encontrado en /public"
            cat "$ROBOTS_PUB"
            echo ""

            # Detectar bloqueos globales
            if grep -q "Disallow: /$" "$ROBOTS_PUB"; then
              echo "âŒ CRÃTICO: robots.txt bloquea TODO el sitio (Disallow: /)"
              echo "   Google no puede indexar ninguna pÃ¡gina."
              exit 1
            fi

            if grep -q "noindex" "$ROBOTS_PUB"; then
              echo "âš ï¸  Se encontrÃ³ 'noindex' en robots.txt â€” verifica que es intencionado"
            fi

            # Comprobar que apunta al sitemap
            if grep -qi "sitemap" "$ROBOTS_PUB"; then
              echo "âœ… robots.txt incluye referencia al sitemap"
            else
              echo "âš ï¸  robots.txt no menciona el sitemap. AÃ±ade:"
              echo "   Sitemap: https://www.derechoartificial.com/sitemap.xml"
            fi

          elif [ -n "$ROBOTS_APP" ]; then
            echo "âœ… robots.ts dinÃ¡mico encontrado: $ROBOTS_APP"
          else
            echo "âš ï¸  No se encontrÃ³ robots.txt ni robots.ts"
            echo "   Se recomienda crear public/robots.txt"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. IMÃGENES â€” Alt text y uso de next/image
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  imagenes:
    name: ğŸ–¼ï¸ ImÃ¡genes y Accesibilidad
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detectar imÃ¡genes sin alt text
        run: |
          echo "ğŸ” Buscando imÃ¡genes sin atributo alt..."
          ERRORES=0

          # <img> sin alt
          while IFS= read -r line; do
            echo "âŒ <img> sin alt: $line"
            ERRORES=$((ERRORES + 1))
          done < <(grep -rn "<img " src/ --include="*.tsx" --include="*.jsx" | grep -v 'alt=' | grep -v '//' || true)

          # <Image> de next/image sin alt
          while IFS= read -r line; do
            echo "âŒ <Image> sin alt: $line"
            ERRORES=$((ERRORES + 1))
          done < <(grep -rn "<Image " src/ --include="*.tsx" --include="*.jsx" | grep -v 'alt=' | grep -v '//' || true)

          if [ "$ERRORES" -eq 0 ]; then
            echo "âœ… Todas las imÃ¡genes tienen atributo alt"
          else
            echo ""
            echo "âš ï¸  $ERRORES imagen(s) sin alt text."
            echo "   El alt text es importante para accesibilidad y SEO."
          fi

      - name: Detectar uso de <img> nativa en lugar de next/image
        run: |
          IMG_NATIVA=$(grep -rn "<img " src/ --include="*.tsx" --include="*.jsx" | grep -v '//' || true)
          if [ -n "$IMG_NATIVA" ]; then
            echo "âš ï¸  Etiquetas <img> nativas detectadas (usa <Image> de next/image):"
            echo "$IMG_NATIVA"
          else
            echo "âœ… Todas las imÃ¡genes usan next/image"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. OPEN GRAPH â€” Comprobaciones de metadatos sociales
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  open-graph:
    name: ğŸ“£ Open Graph y Metadatos sociales
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verificar implementaciÃ³n de Open Graph en layout
        run: |
          echo "ğŸ” Buscando configuraciÃ³n de Open Graph..."

          # Buscar metadataBase (necesario para OG absolutos en Next.js)
          if grep -rn "metadataBase" src/ --include="*.ts" --include="*.tsx" | head -1; then
            echo "âœ… metadataBase configurado"
          else
            echo "âš ï¸  No se encontrÃ³ metadataBase en el layout"
            echo "   Sin esto, las URLs de Open Graph serÃ¡n relativas y no funcionarÃ¡n en redes sociales."
            echo "   AÃ±ade en app/layout.tsx:"
            echo "   metadataBase: new URL('https://www.derechoartificial.com')"
          fi

          # Verificar que hay openGraph configurado
          if grep -rn "openGraph" src/ --include="*.ts" --include="*.tsx" | head -1; then
            echo "âœ… openGraph configurado"
          else
            echo "âš ï¸  No se encontrÃ³ configuraciÃ³n openGraph"
            echo "   Sin esto, los artÃ­culos no mostrarÃ¡n previsualizaciÃ³n al compartir en LinkedIn/Twitter."
          fi

          # Verificar twitter card
          if grep -rn "twitter:" src/ --include="*.ts" --include="*.tsx" | head -1; then
            echo "âœ… Twitter/X card configurada"
          else
            echo "âš ï¸  No se encontrÃ³ configuraciÃ³n de Twitter card"
          fi

      - name: Verificar JSON-LD (datos estructurados para Google)
        run: |
          if grep -rn "application/ld+json" src/ --include="*.tsx" --include="*.ts" | head -1; then
            echo "âœ… JSON-LD encontrado â€” Google puede mostrar rich snippets"
          else
            echo "âš ï¸  No se encontrÃ³ JSON-LD (Schema.org)"
            echo "   Sin esto, Google no puede mostrar rich snippets en los resultados de bÃºsqueda."
            echo "   Considera aÃ±adir Article schema en las pÃ¡ginas de artÃ­culo."
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 6. HREFLANG â€” Sitio bilingÃ¼e ES/EN
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  hreflang:
    name: ğŸŒ Hreflang ES/EN
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verificar configuraciÃ³n de idiomas
        run: |
          echo "ğŸ” Verificando configuraciÃ³n bilingÃ¼e..."

          # Buscar alternates con languages en metadata
          if grep -rn "languages" src/ --include="*.ts" --include="*.tsx" | head -1; then
            echo "âœ… ConfiguraciÃ³n de idiomas (hreflang) encontrada"
          else
            echo "âš ï¸  No se encontrÃ³ hreflang en la configuraciÃ³n de metadata"
            echo "   El sitio tiene versiÃ³n /en pero Google puede no saber cuÃ¡ndo mostrar cada idioma."
            echo "   AÃ±ade en generateMetadata:"
            echo "   alternates: { languages: { 'es': url_es, 'en': url_en } }"
          fi

          # Comprobar que existe la carpeta /en
          if [ -d "src/app/en" ]; then
            echo "âœ… Carpeta /en encontrada para la versiÃ³n inglesa"
          else
            echo "âš ï¸  No se encontrÃ³ src/app/en â€” Â¿dÃ³nde estÃ¡ la versiÃ³n en inglÃ©s?"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 7. RESUMEN FINAL
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  resumen-seo:
    name: ğŸ“Š Resumen SEO
    runs-on: ubuntu-latest
    needs: [frontmatter-seo, sitemap, robots, imagenes, open-graph, hreflang]
    if: always()
    steps:
      - name: Resumen
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  INFORME SEO â€” derechoartificial.com"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  âœ… Verde  = Todo correcto"
          echo "  âš ï¸  Amarillo = Advertencia (no bloquea deploy)"
          echo "  âŒ Rojo   = Error crÃ­tico (bloquea deploy)"
          echo ""
          echo "  Revisa cada job para ver el detalle."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
